# GAS/スプレッドシート 残タスク

## 背景

今回のアプリ改修で以下の機能を追加しました：

1. **2次会投票システム** - メンバーが「行く」「流れに任せる」「お先に」を選択
2. **自分識別機能** - ログイン不要で自分のプロフィールを識別
3. **AIトーク・トリガー** - 詳細画面でAI生成の質問を表示（話のきっかけ作り）

これらを動作させるために、GASとスプレッドシートの改修が必要です。

---

## 1. スプレッドシートの変更

### 現在の構成
| id | name | role | hitokoto | now | topic | core |
|----|------|------|----------|-----|-------|------|

### 追加するカラム

| カラム名 | 目的 |
|---------|------|
| `vote_status` | 投票結果を保存（1=Go, 2=Maybe, 3=Home） |
| `vote_updated_at` | 投票日時を記録（デバッグ・分析用） |
| `ai_questions` | AI生成の質問を保存（詳細画面で表示） |

### 変更後の構成
| id | name | role | hitokoto | now | topic | core | vote_status | vote_updated_at | ai_questions |
|----|------|------|----------|-----|-------|------|-------------|-----------------|--------------|

**作業**: スプレッドシートの1行目（ヘッダー行）に `vote_status`, `vote_updated_at`, `ai_questions` を追加

---

## 2. GASコードの変更

### 2-1. 変更の概要

| 関数 | 目的 |
|------|------|
| `doGet()` | 既存を拡張してaction別に処理を分岐 |
| `getProfiles()` | プロフィール一覧取得（vote_statusは除外） |
| `getVoteStatus()` | 投票状況の集計結果を返す |
| `vote()` | 投票を受け付けてスプシに保存 |
| `resetVotes()` | 全員の投票をリセット（飲み会ごとに使用） |
| `generateAIQuestions()` | OpenAI APIで質問を生成 |

### 2-2. 完全なGASコード

既存のコードを**すべて以下に置き換えて**ください：

```javascript
// ============================================
// 設定
// ============================================
const OPENAI_API_KEY = 'sk-xxxxxxxxxxxxxxx'; // ← ここにAPIキーを設定

// ============================================
// メインエントリーポイント
// ============================================

/**
 * GETリクエストを処理
 *
 * エンドポイント:
 * - ?action=getProfiles : プロフィール一覧取得
 * - ?action=getVoteStatus&user_id=N : 投票状況取得
 * - ?action=vote&user_id=N&status=M : 投票送信
 * - ?action=resetVotes : 全投票リセット
 * - ?action=generateQuestions : AI質問を一括生成
 */
function doGet(e) {
  const action = e?.parameter?.action || 'getProfiles';

  let result;

  try {
    switch (action) {
      case 'getProfiles':
        result = getProfiles();
        break;

      case 'getVoteStatus':
        const userId = e.parameter.user_id ? parseInt(e.parameter.user_id) : null;
        result = getVoteStatus(userId);
        break;

      case 'vote':
        const voteUserId = parseInt(e.parameter.user_id);
        const status = parseInt(e.parameter.status);
        result = vote(voteUserId, status);
        break;

      case 'resetVotes':
        result = resetVotes();
        break;

      case 'generateQuestions':
        result = generateAllQuestions();
        break;

      default:
        result = { success: false, error: 'Unknown action: ' + action };
    }
  } catch (error) {
    result = { success: false, error: error.toString() };
  }

  return ContentService
    .createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}

// CORSプリフライトリクエスト対応
function doOptions() {
  return ContentService
    .createTextOutput('')
    .setMimeType(ContentService.MimeType.JSON);
}

// ============================================
// プロフィール関連
// ============================================

/**
 * プロフィール一覧を取得
 *
 * なぜ必要か：
 * - アプリのメイン画面でメンバー一覧を表示するため
 * - vote_status等の内部データは除外して返す
 */
function getProfiles() {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    const data = sheet.getDataRange().getValues();
    const headers = data[0];

    // 除外するカラム（内部データ）
    const excludeColumns = ['vote_status', 'vote_updated_at'];

    const profiles = [];

    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const profile = {};

      headers.forEach((header, index) => {
        if (!excludeColumns.includes(header)) {
          profile[header] = row[index];
        }
      });

      profiles.push(profile);
    }

    return {
      success: true,
      data: profiles
    };

  } catch (error) {
    return { success: false, error: error.toString() };
  }
}

// ============================================
// 投票関連
// ============================================

/**
 * 投票状況を取得
 *
 * なぜ必要か：
 * - 投票ボタンに「生存率」を表示するため
 * - 投票結果画面で「Go/Maybe」メンバー一覧を表示するため
 * - 自分の投票状況を確認するため
 *
 * @param {number|null} userId - 自分のユーザーID（省略可）
 */
function getVoteStatus(userId) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    const data = sheet.getDataRange().getValues();
    const headers = data[0];

    // カラムインデックスを取得
    const idCol = headers.indexOf('id');
    const nameCol = headers.indexOf('name');
    const voteStatusCol = headers.indexOf('vote_status');

    if (idCol === -1 || nameCol === -1) {
      return { success: false, error: 'Required columns (id, name) not found' };
    }

    if (voteStatusCol === -1) {
      return { success: false, error: 'vote_status column not found. Please add it to the spreadsheet.' };
    }

    let goCount = 0;
    let maybeCount = 0;
    let homeCount = 0;
    let totalVoted = 0;
    const totalMembers = data.length - 1;

    const goMembers = [];
    const maybeMembers = [];
    let myStatus = null;

    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const memberId = row[idCol];
      const memberName = row[nameCol];
      const status = row[voteStatusCol];

      // 投票ステータスを数値に変換
      const statusNum = status ? parseInt(status) : null;

      if (statusNum === 1) {
        goCount++;
        totalVoted++;
        goMembers.push({ id: memberId, name: memberName });
      } else if (statusNum === 2) {
        maybeCount++;
        totalVoted++;
        maybeMembers.push({ id: memberId, name: memberName });
      } else if (statusNum === 3) {
        homeCount++;
        totalVoted++;
      }

      // 自分の投票状況
      if (userId && memberId === userId) {
        myStatus = statusNum;
      }
    }

    // 生存率 = (Go + Maybe) / 投票済み人数 * 100
    const survivalRate = totalVoted > 0
      ? Math.round(((goCount + maybeCount) / totalVoted) * 100)
      : 0;

    return {
      success: true,
      data: {
        survival_rate: survivalRate,
        total_voted: totalVoted,
        total_members: totalMembers,
        my_status: myStatus,
        go_count: goCount,
        maybe_count: maybeCount,
        home_count: homeCount,
        go_members: goMembers,
        maybe_members: maybeMembers
      },
      timestamp: new Date().toISOString()
    };

  } catch (error) {
    return { success: false, error: error.toString() };
  }
}

/**
 * 投票を送信
 *
 * なぜ必要か：
 * - ユーザーが「行く」「流れに任せる」「お先に」を選択した際に保存するため
 * - 投票は何度でも変更可能（上書き）
 *
 * @param {number} userId - ユーザーID
 * @param {number} status - 1=Go, 2=Maybe, 3=Home
 */
function vote(userId, status) {
  try {
    // バリデーション
    if (!userId || isNaN(userId)) {
      return { success: false, error: 'Invalid user_id', code: 'INVALID_USER_ID' };
    }

    if (![1, 2, 3].includes(status)) {
      return { success: false, error: 'Invalid status. Must be 1 (Go), 2 (Maybe), or 3 (Home)', code: 'INVALID_STATUS' };
    }

    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    const data = sheet.getDataRange().getValues();
    const headers = data[0];

    const idCol = headers.indexOf('id');
    const voteStatusCol = headers.indexOf('vote_status');
    const voteUpdatedAtCol = headers.indexOf('vote_updated_at');

    if (voteStatusCol === -1) {
      return { success: false, error: 'vote_status column not found', code: 'COLUMN_NOT_FOUND' };
    }

    // ユーザーの行を探す
    let userRowIndex = -1;
    for (let i = 1; i < data.length; i++) {
      if (data[i][idCol] === userId || data[i][idCol] === String(userId)) {
        userRowIndex = i + 1; // シートは1始まり
        break;
      }
    }

    if (userRowIndex === -1) {
      return { success: false, error: 'User not found', code: 'USER_NOT_FOUND' };
    }

    // 投票ステータスを更新
    const now = new Date();
    sheet.getRange(userRowIndex, voteStatusCol + 1).setValue(status);

    // 更新日時も記録
    if (voteUpdatedAtCol !== -1) {
      sheet.getRange(userRowIndex, voteUpdatedAtCol + 1).setValue(now);
    }

    const statusLabels = { 1: 'Go', 2: 'Maybe', 3: 'Home' };

    return {
      success: true,
      message: `投票を受け付けました: ${statusLabels[status]}`,
      data: {
        user_id: userId,
        status: status,
        updated_at: now.toISOString()
      }
    };

  } catch (error) {
    return { success: false, error: error.toString(), code: 'INTERNAL_ERROR' };
  }
}

/**
 * 全員の投票をリセット
 *
 * なぜ必要か：
 * - 次回の飲み会前に全員の投票をクリアするため
 * - 管理者が手動で実行
 */
function resetVotes() {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    const data = sheet.getDataRange().getValues();
    const headers = data[0];

    const voteStatusCol = headers.indexOf('vote_status');
    const voteUpdatedAtCol = headers.indexOf('vote_updated_at');

    if (voteStatusCol === -1) {
      return { success: false, error: 'vote_status column not found' };
    }

    const numRows = data.length - 1;

    if (numRows > 0) {
      // vote_status をクリア
      sheet.getRange(2, voteStatusCol + 1, numRows, 1).clearContent();

      // vote_updated_at もクリア
      if (voteUpdatedAtCol !== -1) {
        sheet.getRange(2, voteUpdatedAtCol + 1, numRows, 1).clearContent();
      }
    }

    return {
      success: true,
      message: '全員の投票をリセットしました',
      reset_count: numRows
    };

  } catch (error) {
    return { success: false, error: error.toString() };
  }
}

// ============================================
// AI質問生成
// ============================================

/**
 * 全メンバーのAI質問を一括生成
 *
 * なぜ必要か：
 * - 詳細画面で「この人に聞いてみよう」という質問を表示
 * - 飲み会での話のきっかけ作りに使用
 * - 事前に一括生成してスプシに保存（APIコスト削減）
 */
function generateAllQuestions() {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    const data = sheet.getDataRange().getValues();
    const headers = data[0];

    const aiQuestionsCol = headers.indexOf('ai_questions');

    if (aiQuestionsCol === -1) {
      return { success: false, error: 'ai_questions column not found. Please add it to the spreadsheet.' };
    }

    const nameCol = headers.indexOf('name');
    const roleCol = headers.indexOf('role');
    const hitokotoCol = headers.indexOf('hitokoto');
    const nowCol = headers.indexOf('now');
    const topicCol = headers.indexOf('topic');
    const coreCol = headers.indexOf('core');

    let generatedCount = 0;
    let skippedCount = 0;
    const errors = [];

    for (let i = 1; i < data.length; i++) {
      const row = data[i];

      // 既にai_questionsがある場合はスキップ
      if (row[aiQuestionsCol] && row[aiQuestionsCol].toString().trim() !== '') {
        skippedCount++;
        continue;
      }

      const profile = {
        name: row[nameCol],
        role: row[roleCol],
        hitokoto: row[hitokotoCol],
        now: row[nowCol],
        topic: row[topicCol],
        core: row[coreCol]
      };

      try {
        const questions = generateQuestionsForProfile(profile);

        if (questions && questions.length > 0) {
          // JSON文字列として保存
          const questionsJson = JSON.stringify(questions);
          sheet.getRange(i + 1, aiQuestionsCol + 1).setValue(questionsJson);
          generatedCount++;
        }

        // API制限対策：少し待機
        Utilities.sleep(1000);

      } catch (error) {
        errors.push({ name: profile.name, error: error.toString() });
      }
    }

    return {
      success: true,
      message: `AI質問を生成しました`,
      generated: generatedCount,
      skipped: skippedCount,
      errors: errors
    };

  } catch (error) {
    return { success: false, error: error.toString() };
  }
}

/**
 * 1人分のAI質問を生成
 *
 * @param {Object} profile - プロフィール情報
 * @returns {string[]} - 質問の配列
 */
function generateQuestionsForProfile(profile) {
  if (!OPENAI_API_KEY || OPENAI_API_KEY === 'sk-xxxxxxxxxxxxxxx') {
    // APIキー未設定時はデフォルト質問を返す
    return [
      `${profile.role}として働く中で一番やりがいを感じる瞬間は？`,
      `「${profile.hitokoto}」って素敵ですね。そう思うようになったきっかけは？`,
      `最近の${profile.topic}について、もっと詳しく聞かせてください！`
    ];
  }

  const prompt = `
あなたは飲み会で使える会話のきっかけを作るアシスタントです。
以下のプロフィール情報を元に、この人に聞いてみたくなる質問を3つ生成してください。

【プロフィール】
- 名前: ${profile.name}
- 役割: ${profile.role}
- 一言: ${profile.hitokoto}
- 今やっていること: ${profile.now}
- 最近のトピック: ${profile.topic}
- 大切にしていること: ${profile.core}

【ルール】
- フレンドリーで親しみやすい口調
- 相手が話したくなるようなオープンクエスチョン
- プロフィールの内容に具体的に触れる
- 1質問あたり30文字以内

JSON配列形式で出力してください。例: ["質問1", "質問2", "質問3"]
`;

  const response = UrlFetchApp.fetch('https://api.openai.com/v1/chat/completions', {
    method: 'post',
    headers: {
      'Authorization': 'Bearer ' + OPENAI_API_KEY,
      'Content-Type': 'application/json'
    },
    payload: JSON.stringify({
      model: 'gpt-4o-mini',
      messages: [
        { role: 'user', content: prompt }
      ],
      temperature: 0.7,
      max_tokens: 200
    })
  });

  const result = JSON.parse(response.getContentText());
  const content = result.choices[0].message.content;

  // JSON配列をパース
  const jsonMatch = content.match(/\[[\s\S]*\]/);
  if (jsonMatch) {
    return JSON.parse(jsonMatch[0]);
  }

  return [];
}

/**
 * 特定ユーザーのAI質問を再生成（手動実行用）
 *
 * @param {number} userId - ユーザーID
 */
function regenerateQuestionsForUser(userId) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    const data = sheet.getDataRange().getValues();
    const headers = data[0];

    const idCol = headers.indexOf('id');
    const aiQuestionsCol = headers.indexOf('ai_questions');

    if (aiQuestionsCol === -1) {
      return { success: false, error: 'ai_questions column not found' };
    }

    // ユーザーを探す
    for (let i = 1; i < data.length; i++) {
      if (data[i][idCol] === userId || data[i][idCol] === String(userId)) {
        const profile = {
          name: data[i][headers.indexOf('name')],
          role: data[i][headers.indexOf('role')],
          hitokoto: data[i][headers.indexOf('hitokoto')],
          now: data[i][headers.indexOf('now')],
          topic: data[i][headers.indexOf('topic')],
          core: data[i][headers.indexOf('core')]
        };

        const questions = generateQuestionsForProfile(profile);
        sheet.getRange(i + 1, aiQuestionsCol + 1).setValue(JSON.stringify(questions));

        return { success: true, questions: questions };
      }
    }

    return { success: false, error: 'User not found' };

  } catch (error) {
    return { success: false, error: error.toString() };
  }
}
```

---

## 3. 作業手順

### Step 1: スプレッドシートにカラムを追加

1. スプレッドシートを開く
2. 1行目（ヘッダー行）の `core` の右に以下を追加：
   - H列: `vote_status`
   - I列: `vote_updated_at`
   - J列: `ai_questions`

### Step 2: GASコードを更新

1. スプレッドシートのメニュー → **拡張機能** → **Apps Script**
2. 既存のコードを**すべて削除**
3. 上記の完全なGASコードを**貼り付け**
4. **1行目**の `OPENAI_API_KEY` にあなたのAPIキーを設定：
   ```javascript
   const OPENAI_API_KEY = 'sk-あなたのキー';
   ```
5. **Ctrl+S** で保存

### Step 3: 新しいデプロイを作成

1. **デプロイ** → **新しいデプロイ**
2. 歯車アイコン → **ウェブアプリ**
3. 設定：
   - 説明: 「投票機能追加」など
   - 実行ユーザー: **自分**
   - アクセスできるユーザー: **全員**
4. **デプロイ** をクリック
5. **アクセスを承認** → Googleアカウントで許可
6. 表示されたURLをコピー

### Step 4: アプリの環境変数を更新

`.env.local` を編集：
```
VITE_GAS_API_URL=https://script.google.com/macros/s/新しいスクリプトID/exec
```

### Step 5: AI質問を生成

1. ブラウザで以下にアクセス：
   ```
   https://script.google.com/.../exec?action=generateQuestions
   ```
2. 全メンバーのAI質問が `ai_questions` カラムに保存される

### Step 6: 動作確認

ブラウザで各エンドポイントをテスト：

```
# プロフィール取得
?action=getProfiles

# 投票状況取得
?action=getVoteStatus

# 投票テスト（ID=1がGoを選択）
?action=vote&user_id=1&status=1

# 投票リセット
?action=resetVotes
```

---

## 4. チェックリスト

### スプレッドシート
- [ ] `vote_status` カラムを追加
- [ ] `vote_updated_at` カラムを追加
- [ ] `ai_questions` カラムを追加

### GAS
- [ ] コードを全て置き換え
- [ ] OpenAI APIキーを設定
- [ ] 保存
- [ ] 新しいデプロイを作成
- [ ] URLをコピー

### アプリ
- [ ] `.env.local` のURLを更新
- [ ] `npm run dev` で動作確認

### テスト
- [ ] プロフィール一覧が表示される
- [ ] 投票ボタンが機能する
- [ ] 投票結果が表示される
- [ ] 詳細画面にAI質問が表示される

---

## 5. トラブルシューティング

### 「vote_status column not found」エラー
→ スプレッドシートに `vote_status` カラムがない。Step 1を確認。

### 投票しても反映されない
→ GASのデプロイが古い可能性。新しいデプロイを作成。

### AI質問が表示されない
→ `?action=generateQuestions` を実行してai_questionsを生成。

### CORSエラー
→ GASのデプロイ設定で「アクセスできるユーザー」が「全員」になっているか確認。
